<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurelius</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;background:#fff;color:#111;max-width:700px;margin:40px auto;padding:20px}h1{font-size:2em;margin-bottom:20px}#search{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px;font-size:1em}.toolbar{display:flex;gap:10px;margin-bottom:20px}#search{flex:1}#content{margin:20px 0}details{margin:15px 0;padding:10px;background:#f9f9f9;border-radius:4px}details[open]{background:#f0f0f0}summary{cursor:pointer;font-weight:bold;user-select:none}summary:hover{color:#0066cc}summary span{margin-right:10px}summary .count{color:#888;font-weight:normal}a{display:block;padding:8px 0;color:#0066cc;text-decoration:none;border-bottom:1px solid #eee}a:hover{color:#0052a3;text-decoration:underline}a.hidden{display:none}#update-time{margin-top:20px;padding-top:20px;border-top:1px solid #ddd;color:#666;font-size:0.9em;text-align:center}
</style>
</head>
<body>

<h1>Aurelius</h1>

<div class="toolbar">
  <input type="text" id="search" placeholder="搜索名称、URL、标签或分类...">
</div>

<div id="content"></div>

<div id="update-time">加载中...</div>

<script>
const d = document;
const s = d.getElementById('search');
const c = d.getElementById('content');
const u = d.getElementById('update-time');

let siteGroups = [];

// 创建链接元素
function createLink(link) {
  const a = d.createElement('a');
  a.href = link.url;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  a.textContent = link.title;
  a.dataset.title = link.title.toLowerCase();
  a.dataset.url = link.url.toLowerCase();
  a.dataset.tags = (link.tags || '').toLowerCase();
  if (link.tags && link.tags.trim()) a.title = link.tags;
  return a;
}

// 渲染网站
function render() {
  c.innerHTML = '';
  siteGroups.forEach(g => {
    const sec = d.createElement('details');
    sec.dataset.category = g.category.toLowerCase();
    const sum = d.createElement('summary');
    const titleSpan = d.createElement('span');
    titleSpan.textContent = g.category;
    const countSpan = d.createElement('span');
    countSpan.className = 'count';
    countSpan.textContent = `(${g.links.length})`;
    sum.appendChild(titleSpan);
    sum.appendChild(countSpan);
    sec.appendChild(sum);
    g.links.forEach(l => sec.appendChild(createLink(l)));
    c.appendChild(sec);
  });
}

function validateSiteGroups(data) {
  if (!Array.isArray(data)) return null;

  const cleaned = data
    .filter(group => group && typeof group === 'object')
    .map(group => {
      const category = typeof group.category === 'string' ? group.category.trim() : '';
      const links = Array.isArray(group.links) ? group.links : [];

      const cleanedLinks = links
        .filter(link => link && typeof link === 'object')
        .map(link => ({
          title: typeof link.title === 'string' ? link.title.trim() : '',
          url: typeof link.url === 'string' ? link.url.trim() : '',
          tags: typeof link.tags === 'string' ? link.tags.trim() : ''
        }))
        .filter(link => link.title && link.url);

      return { category, links: cleanedLinks };
    })
    .filter(group => group.category && group.links.length);

  return cleaned;
}

// 搜索过滤
function filter() {
  const q = s.value.toLowerCase().trim();
  d.querySelectorAll('#content details').forEach(sec => {
    let show = false;
    sec.querySelectorAll('a').forEach(a => {
      const match = !q || a.dataset.title.includes(q) || a.dataset.url.includes(q) || a.dataset.tags.includes(q) || sec.dataset.category.includes(q);
      a.classList.toggle('hidden', !match);
      if (match) show = true;
    });
    sec.classList.toggle('hidden', !show);
  });
}

// 获取最后更新时间
function updateTime() {
  fetch('https://api.github.com/repos/AureliusWu/AureliusWu.github.io/commits?per_page=1')
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      if (!data || data.length === 0) throw new Error('No commits found');
      const lastCommitDate = new Date(data[0].commit.author.date);
      const formattedDate = lastCommitDate.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      u.textContent = `本页面最后更新时间：${formattedDate}`;
    })
    .catch(error => {
      console.error('获取更新时间失败:', error);
      u.textContent = '本页面最后更新时间：获取失败';
    });
}

// 初始化
async function init() {
  try {
    const res = await fetch('data.json');
    const loaded = validateSiteGroups(await res.json());
    siteGroups = loaded || [];
  } catch (e) {
    console.warn('无法加载 data.json，使用默认数据');
    siteGroups = [];
  }
  
  render();
  updateTime();
  
  s.addEventListener('input', filter);
  s.focus();
  
  setInterval(updateTime, 600000); // 每10分钟更新一次时间
}

d.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
